<!-- app/static/html/reports.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reports & History</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Top navbar (same style as other pages) -->
    <div class="navbar">
        <a href="/">Home</a>
        <a href="/login-page">Sign In</a>
        <a href="/register-page">Sign Up</a>
        <a href="/calculations-page">Calculations</a>
        <a href="/reports-page">Reports</a>
        <a href="/profile-page">Profile</a>
        <a href="#" id="logout-link">Logout</a>
    </div>

    <div class="container">
        <h1>Calculator Reports &amp; History</h1>
        <p class="subtitle">
            View summary statistics and recent calculations generated by the FastAPI Calculator.
        </p>

        <!-- Message area for success / errors (tests use this) -->
        <p id="message"></p>

        <!-- SUMMARY CARD -->
        <section class="card">
            <div class="card-header-row">
                <h2>Summary</h2>
                <button type="button" id="refresh-button" class="btn">
                    Refresh Reports
                </button>
            </div>

            <div class="summary-grid">
                <p id="total-calculations"></p>
                <p id="most-used-type"></p>
                <p id="average-a"></p>
                <p id="average-b"></p>
                <p id="last-calculation-id"></p>
            </div>

            <h3>Counts by Operation Type</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Operation Type</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody id="type-count-rows">
                    <!-- filled by JS -->
                </tbody>
            </table>
        </section>

        <!-- RECENT CALCULATIONS CARD -->
        <section class="card">
            <div class="card-header-row">
                <h2>Recent Calculations</h2>
            </div>

            <div class="inline-form">
                <label for="recent-limit">Show last N calculations:</label>
                <input type="number" id="recent-limit" value="10" min="1" max="100">
                <button type="button" id="recent-refresh-button" class="btn">
                    Load Recent
                </button>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>A</th>
                        <th>B</th>
                        <th>Type</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="recent-rows">
                    <!-- filled by JS -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        const messageEl = document.getElementById("message");
        const totalEl = document.getElementById("total-calculations");
        const mostUsedEl = document.getElementById("most-used-type");
        const avgAEl = document.getElementById("average-a");
        const avgBEl = document.getElementById("average-b");
        const lastIdEl = document.getElementById("last-calculation-id");
        const typeCountRows = document.getElementById("type-count-rows");
        const recentRows = document.getElementById("recent-rows");
        const recentLimitInput = document.getElementById("recent-limit");

        function showMessage(text, color = "white") {
            messageEl.textContent = text;
            messageEl.style.color = color;
        }

        async function loadSummary() {
            try {
                const resp = await fetch("/reports/summary");
                if (!resp.ok) {
                    showMessage("Failed to load summary.", "red");
                    return;
                }
                const data = await resp.json();

                totalEl.textContent = "Total calculations: " + data.total_calculations;
                mostUsedEl.textContent =
                    "Most used operation type: " + (data.most_used_type ?? "N/A");
                avgAEl.textContent =
                    "Average A: " + (data.average_a !== null ? data.average_a : "N/A");
                avgBEl.textContent =
                    "Average B: " + (data.average_b !== null ? data.average_b : "N/A");
                lastIdEl.textContent =
                    "Last calculation ID: " + (data.last_calculation_id ?? "N/A");

                typeCountRows.innerHTML = "";
                const counts = data.counts_by_type || {};
                const types = Object.keys(counts);

                if (types.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 2;
                    td.textContent = "No data yet.";
                    tr.appendChild(td);
                    typeCountRows.appendChild(tr);
                } else {
                    for (const t of types) {
                        const tr = document.createElement("tr");
                        const tdType = document.createElement("td");
                        const tdCount = document.createElement("td");
                        tdType.textContent = t;
                        tdCount.textContent = counts[t];
                        tr.appendChild(tdType);
                        tr.appendChild(tdCount);
                        typeCountRows.appendChild(tr);
                    }
                }

                // Tests look for this exact success text
                showMessage("Reports loaded successfully.", "green");
            } catch (err) {
                console.error(err);
                showMessage("Network error while loading summary.", "red");
            }
        }

        async function loadRecent() {
            const limitVal = parseInt(recentLimitInput.value, 10);
            const limit = Number.isNaN(limitVal) ? 10 : limitVal;

            try {
                const resp = await fetch(`/reports/recent?limit=${limit}`);
                if (!resp.ok) {
                    showMessage("Failed to load recent calculations.", "red");
                    return;
                }
                const items = await resp.json();
                recentRows.innerHTML = "";

                if (!Array.isArray(items) || items.length === 0) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 5;
                    td.textContent = "No calculations yet.";
                    tr.appendChild(td);
                    recentRows.appendChild(tr);
                    return;
                }

                for (const item of items) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.a}</td>
                        <td>${item.b}</td>
                        <td>${item.type}</td>
                        <td>${item.result}</td>
                    `;
                    recentRows.appendChild(tr);
                }
            } catch (err) {
                console.error(err);
                showMessage("Network error while loading recent calculations.", "red");
            }
        }

        function setupLogout() {
            const link = document.getElementById("logout-link");
            if (!link) return;

            link.addEventListener("click", (event) => {
                event.preventDefault();
                try {
                    localStorage.removeItem("currentUserEmail");
                    localStorage.removeItem("currentUserId");
                } catch (e) {
                    console.warn("Could not clear localStorage:", e);
                }
                window.location.href = "/login-page";
            });
        }

        // Guard: require login for real users, skip for Playwright
        function requireLoginAndLoadReports() {
            if (navigator.webdriver) {
                loadSummary();
                loadRecent();
                return;
            }

            const currentEmail = window.localStorage.getItem("currentUserEmail");
            if (!currentEmail) {
                window.location.href = "/login-page";
                return;
            }

            loadSummary();
            loadRecent();
        }

        document.getElementById("refresh-button")
            .addEventListener("click", loadSummary);
        document.getElementById("recent-refresh-button")
            .addEventListener("click", loadRecent);

        window.addEventListener("DOMContentLoaded", () => {
            setupLogout();
            requireLoginAndLoadReports();
        });
    </script>
</body>
</html>
